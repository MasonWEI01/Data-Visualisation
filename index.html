<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Chart Visualization Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            background: white;
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .left-panel {
            width: 25%;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .center-panel {
            width: 60%;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            width: 15%;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #ecf0f1;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .chart-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-container {
            flex: 1;
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background: #3498db;
            color: white;
        }

        .data-table tr:nth-child(even) {
            background: #f2f2f2;
        }

        .color-theme {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover,
        .color-option.active {
            border-color: #2c3e50;
            transform: scale(1.1);
        }

        .theme-1 { background: linear-gradient(45deg, #3498db, #2980b9); }
        .theme-2 { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .theme-3 { background: linear-gradient(45deg, #2ecc71, #27ae60); }
        .theme-4 { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .theme-5 { background: linear-gradient(45deg, #9b59b6, #8e44ad); }

        .sample-data {
            margin: 20px 0;
        }

        .sample-btn {
            display: block;
            width: 100%;
            margin: 5px 0;
            text-align: left;
            background: #ecf0f1;
            color: #2c3e50;
        }

        .sample-btn:hover {
            background: #bdc3c7;
        }

        .export-section {
            margin-top: 20px;
        }

        .error-cell {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }

        .suggestion-box {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }

        .suggestion-title {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                margin: 5px;
            }

            .left-panel,
            .center-panel,
            .right-panel {
                width: 100%;
            }

            .chart-toolbar {
                justify-content: center;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mini-charts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .mini-chart {
            background: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: 250px;
            position: relative;
        }

        .mini-chart canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .mini-charts::-webkit-scrollbar {
            width: 8px;
        }

        .mini-charts::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .mini-charts::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        .mini-charts::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Data Panel -->
        <div class="left-panel">
            <h2 class="panel-title">üìä Data Input</h2>
            
            <!-- File Upload Area -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p>Drag Excel/CSV files here</p>
                <p>or click to select files</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>

            <!-- Sample Data -->
            <div class="sample-data">
                <h3 style="margin-bottom: 10px;">üìã Sample Data</h3>
                <button class="btn sample-btn" onclick="loadSampleData('sales')">Sales Data</button>
                <button class="btn sample-btn" onclick="loadSampleData('grades')">Student Grades</button>
                <button class="btn sample-btn" onclick="loadSampleData('traffic')">Website Traffic</button>
            </div>

            <!-- Data Preview -->
            <div id="dataPreview">
                <h3 style="margin: 20px 0 10px 0;">üìã Data Preview</h3>
                <div id="dataTable"></div>
            </div>

            <!-- Paste Data Area -->
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">üìù Paste Data</h3>
                <textarea id="pasteArea" placeholder="Copy table data from Excel/WPS and paste here..." 
                         style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                <button class="btn" onclick="processPastedData()" style="margin-top: 10px;">Parse Data</button>
            </div>
        </div>

        <!-- Center Chart Panel -->
        <div class="center-panel">
            <h2 class="panel-title">üìà Chart Display</h2>
            
            <!-- Chart Toolbar -->
            <div class="chart-toolbar">
                <button class="btn" onclick="changeChartType('bar')">üìä Bar Chart</button>
                <button class="btn" onclick="changeChartType('line')">üìà Line Chart</button>
                <button class="btn" onclick="changeChartType('pie')">ü•ß Pie Chart</button>
                <button class="btn" onclick="changeChartType('scatter')">‚ö´ Scatter Plot</button>
                <button class="btn" onclick="toggleDualAxis()">üìäüìà Dual Axis</button>
                <button class="btn" onclick="toggleMiniCharts()">üî≤ Mini Charts</button>
            </div>

            <!-- Smart Suggestions -->
            <div id="suggestions"></div>

            <!-- Loading Animation -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Generating chart...</p>
            </div>

            <!-- ÂõæË°®ÂÆπÂô® -->
            <div class="chart-container" id="chartContainer">
                <canvas id="mainChart"></canvas>
            </div>

            <!-- Ëø∑‰Ω†ÂõæË°®ÂÆπÂô® -->
            <div class="mini-charts" id="miniChartsContainer" style="display: none;"></div>
        </div>

        <!-- Right Style Panel -->
        <div class="right-panel">
            <h2 class="panel-title">üé® Style</h2>
            
            <!-- Color Theme -->
            <div>
                <h3 style="margin-bottom: 10px;">Color Theme</h3>
                <div class="color-theme">
                    <div class="color-option theme-1 active" onclick="changeTheme(1)"></div>
                    <div class="color-option theme-2" onclick="changeTheme(2)"></div>
                </div>
                <div class="color-theme">
                    <div class="color-option theme-3" onclick="changeTheme(3)"></div>
                    <div class="color-option theme-4" onclick="changeTheme(4)"></div>
                </div>
                <div class="color-theme">
                    <div class="color-option theme-5" onclick="changeTheme(5)"></div>
                </div>
            </div>

            <!-- Export Functions -->
            <div class="export-section">
                <h3 style="margin-bottom: 10px;">üì§ Export</h3>
                <button class="btn btn-small" onclick="exportChart('png')" style="width: 100%; margin-bottom: 5px;">PNG Image</button>
                <button class="btn btn-small" onclick="exportChart('svg')" style="width: 100%; margin-bottom: 5px;">SVG Image</button>
                <button class="btn btn-small" onclick="exportHTML()" style="width: 100%; margin-bottom: 5px;">HTML Snippet</button>
                <button class="btn btn-small" onclick="generateShareLink()" style="width: 100%;">Generate Share Link</button>
            </div>

            <!-- Chart Settings -->
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">‚öôÔ∏è Settings</h3>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="showLegend" checked onchange="updateChart()"> Show Legend
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="showGrid" checked onchange="updateChart()"> Show Grid
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    Chart Title:
                    <input type="text" id="chartTitle" placeholder="Enter title" onchange="updateChart()" 
                           style="width: 100%; margin-top: 5px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                </label>
            </div>
        </div>
    </div>

    <script>
        // Ê≥®ÂÜådatalabelsÊèí‰ª∂
        Chart.register(ChartDataLabels);
        
        // ÂÖ®Â±ÄÂèòÈáè
        let currentData = null;
        let currentChart = null;
        let currentChartType = 'bar';
        let currentTheme = 1;
        let isDualAxis = false;
        let isMiniMode = false;

        // È¢úËâ≤‰∏ªÈ¢òÈÖçÁΩÆ
        const themes = {
            1: ['#3498db', '#2980b9', '#1abc9c', '#16a085', '#f39c12'],
            2: ['#e74c3c', '#c0392b', '#e67e22', '#d35400', '#f39c12'],
            3: ['#2ecc71', '#27ae60', '#1abc9c', '#16a085', '#3498db'],
            4: ['#f39c12', '#e67e22', '#d35400', '#e74c3c', '#c0392b'],
            5: ['#9b59b6', '#8e44ad', '#3498db', '#2980b9', '#1abc9c']
        };

        // Sample data
        const sampleDatasets = {
            sales: {
                headers: ['Month', 'Sales', 'Growth Rate'],
                data: [
                    ['Jan', 120000, 15],
                    ['Feb', 135000, 12.5],
                    ['Mar', 148000, 9.6],
                    ['Apr', 162000, 9.5],
                    ['May', 175000, 8.0],
                    ['Jun', 188000, 7.4]
                ]
            },
            grades: {
                headers: ['Subject', 'Average Score', 'Pass Rate'],
                data: [
                    ['Math', 85, 92],
                    ['Chinese', 78, 88],
                    ['English', 82, 90],
                    ['Physics', 76, 85],
                    ['Chemistry', 80, 87]
                ]
            },
            traffic: {
                headers: ['Date', 'Visits', 'Page Views'],
                data: [
                    ['Monday', 1200, 3600],
                    ['Tuesday', 1350, 4050],
                    ['Wednesday', 1180, 3540],
                    ['Thursday', 1420, 4260],
                    ['Friday', 1680, 5040],
                    ['Saturday', 2100, 6300],
                    ['Sunday', 1950, 5850]
                ]
            }
        };

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadFromURL();
            loadFromStorage();
            
            // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
            updateButtonStates();
        });

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Êñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // Á≤òË¥¥‰∫ã‰ª∂
            document.getElementById('pasteArea').addEventListener('paste', function(e) {
                setTimeout(() => processPastedData(), 100);
            });
        }

        // ÊãñÊãΩÂ§ÑÁêÜ
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Êñá‰ª∂Â§ÑÁêÜ
        function processFile(file) {
            showLoading(true);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else {
                        const workbook = XLSX.read(e.target.result, {type: 'binary'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    }
                    
                    processData(data);
                } catch (error) {
                    alert('File parsing failed: ' + error.message);
                } finally {
                    showLoading(false);
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // CSVËß£Êûê
        function parseCSV(text) {
            const lines = text.split('\n');
            return lines.map(line => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }).filter(row => row.some(cell => cell !== ''));
        }

        // Á≤òË¥¥Êï∞ÊçÆÂ§ÑÁêÜ
        function processPastedData() {
            const text = document.getElementById('pasteArea').value;
            if (!text.trim()) return;

            const lines = text.split('\n').filter(line => line.trim());
            const data = lines.map(line => line.split('\t'));
            
            processData(data);
        }

        // Data processing
        function processData(rawData) {
            if (!rawData || rawData.length === 0) {
                alert('No valid data found');
                return;
            }

            // Data cleaning and validation
            const cleanData = rawData.filter(row => row.some(cell => cell !== ''));
            
            if (cleanData.length > 10000) {
                if (!confirm('Large dataset (over 10,000 rows) may affect performance. Continue?')) {
                    return;
                }
            }

            currentData = {
                headers: cleanData[0],
                data: cleanData.slice(1)
            };

            displayDataPreview();
            generateChart();
            showSuggestions();
            saveToStorage();
        }

        // ÊòæÁ§∫Êï∞ÊçÆÈ¢ÑËßà
        function displayDataPreview() {
            if (!currentData) return;

            let html = '<table class="data-table"><thead><tr>';
            currentData.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Show only first 10 rows
            const previewData = currentData.data.slice(0, 10);
            previewData.forEach(row => {
                html += '<tr>';
                row.forEach((cell, index) => {
                    const isEmpty = !cell || cell.toString().trim() === '';
                    const className = isEmpty ? 'error-cell' : '';
                    html += `<td class="${className}">${cell || 'Empty'}</td>`;
                });
                html += '</tr>';
            });

            if (currentData.data.length > 10) {
                html += `<tr><td colspan="${currentData.headers.length}" style="text-align: center; font-style: italic;">... ${currentData.data.length - 10} more rows</td></tr>`;
            }

            html += '</tbody></table>';
            document.getElementById('dataTable').innerHTML = html;
        }

        // ÁîüÊàêÂõæË°®
        function generateChart() {
            if (!currentData) return;

            showLoading(true);
            
            setTimeout(() => {
                try {
                    if (isMiniMode) {
                        generateMiniCharts();
                    } else {
                        generateMainChart();
                    }
                } finally {
                    showLoading(false);
                }
            }, 100);
        }

        // ÁîüÊàê‰∏ªÂõæË°®
        function generateMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }

            const chartData = prepareChartData();
            const config = getChartConfig(chartData);
            
            currentChart = new Chart(ctx, config);
        }

        // ÂáÜÂ§áÂõæË°®Êï∞ÊçÆ
        function prepareChartData() {
            if (!currentData) return null;

            const labels = currentData.data.map(row => row[0]);
            const datasets = [];

            // Â§ÑÁêÜÊï∞ÂÄºÂàó
            for (let i = 1; i < currentData.headers.length; i++) {
                const data = currentData.data.map(row => {
                    const value = parseFloat(row[i]);
                    return isNaN(value) ? 0 : value;
                });

                datasets.push({
                    label: currentData.headers[i],
                    data: data,
                    backgroundColor: themes[currentTheme][i - 1] || themes[currentTheme][0],
                    borderColor: themes[currentTheme][i - 1] || themes[currentTheme][0],
                    borderWidth: 2,
                    fill: false
                });
            }

            return { labels, datasets };
        }

        // Ëé∑ÂèñÂõæË°®ÈÖçÁΩÆ
        function getChartConfig(chartData) {
            const showLegend = document.getElementById('showLegend').checked;
            const showGrid = document.getElementById('showGrid').checked;
            const title = document.getElementById('chartTitle').value;

            const config = {
                type: currentChartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: !!title,
                            text: title,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: showLegend
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: showGrid }
                        },
                        y: {
                            grid: { display: showGrid }
                        }
                    }
                }
            };

            // ÂèåËΩ¥Ê®°Âºè
            if (isDualAxis && chartData.datasets.length >= 2) {
                config.data.datasets[1].yAxisID = 'y1';
                config.options.scales.y1 = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false }
                };
            }

            // È•ºÂõæÁâπÊÆäÂ§ÑÁêÜ
            if (currentChartType === 'pie') {
                config.data.datasets = [{
                    data: chartData.datasets[0].data,
                    backgroundColor: themes[currentTheme],
                    label: chartData.datasets[0].label
                }];
                
                // Ê∑ªÂä†ÁôæÂàÜÊØîÊï∞ÊçÆÊ†áÁ≠æ
                config.options.plugins.datalabels = {
                    display: true,
                    color: '#fff',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    formatter: (value, context) => {
                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    },
                    anchor: 'center',
                    align: 'center'
                };
                
                // ÁßªÈô§È•ºÂõæÁöÑÂùêÊ†áËΩ¥
                config.options.scales = {};
            }

            return config;
        }

        // ÁîüÊàêËø∑‰Ω†ÂõæË°®
        function generateMiniCharts() {
            const container = document.getElementById('miniChartsContainer');
            container.innerHTML = '';

            if (!currentData || currentData.headers.length < 2) return;

            const chartTypes = [
                { type: 'bar', name: 'Bar Chart' },
                { type: 'line', name: 'Line Chart' },
                { type: 'pie', name: 'Pie Chart' },
                { type: 'scatter', name: 'Scatter Chart' }
            ];
            
            chartTypes.forEach(chartInfo => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'mini-chart';
                chartDiv.innerHTML = `<canvas id="mini-${chartInfo.type}"></canvas>`;
                container.appendChild(chartDiv);

                const ctx = chartDiv.querySelector('canvas').getContext('2d');
                const chartData = prepareChartData();
                
                // È•ºÂõæÁâπÊÆäÂ§ÑÁêÜ
                if (chartInfo.type === 'pie' && chartData.datasets.length > 0) {
                    chartData.datasets = [{
                        data: chartData.datasets[0].data,
                        backgroundColor: themes[currentTheme],
                        label: chartData.datasets[0].label
                    }];
                }

                // ÂàõÂª∫Ëø∑‰Ω†ÂõæÈÖçÁΩÆ
                const miniConfig = {
                    type: chartInfo.type,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: { size: 10 },
                                    boxWidth: 12
                                }
                            },
                            title: {
                                display: true,
                                text: chartInfo.name,
                                font: { size: 14, weight: 'bold' },
                                padding: { bottom: 10 }
                            },
                            tooltip: {
                                enabled: true,
                                titleFont: { size: 11 },
                                bodyFont: { size: 10 }
                            }
                        }
                    }
                };

                // ‰∏∫ÈùûÈ•ºÂõæÊ∑ªÂä†ÂùêÊ†áËΩ¥
                if (chartInfo.type !== 'pie') {
                    miniConfig.options.scales = {
                        x: {
                            display: true,
                            grid: { display: true, color: '#e9ecef' },
                            ticks: {
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            title: {
                                display: true,
                                text: currentData.headers[0],
                                font: { size: 10 }
                            }
                        },
                        y: {
                            display: true,
                            grid: { display: true, color: '#e9ecef' },
                            ticks: {
                                font: { size: 9 }
                            },
                            title: {
                                display: true,
                                text: currentData.headers[1],
                                font: { size: 10 }
                            }
                        }
                    };
                }

                // ‰∏∫È•ºÂõæÊ∑ªÂä†ÁôæÂàÜÊØîÊï∞ÊçÆÊ†áÁ≠æ
                if (chartInfo.type === 'pie') {
                    miniConfig.options.plugins.datalabels = {
                        display: true,
                        color: '#fff',
                        font: {
                            size: 10,
                            weight: 'bold'
                        },
                        formatter: (value, context) => {
                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return percentage + '%';
                        },
                        anchor: 'center',
                        align: 'center'
                    };
                    // ÁßªÈô§È•ºÂõæÁöÑÂùêÊ†áËΩ¥
                    miniConfig.options.scales = {};
                }

                // ‰∏∫Êï£ÁÇπÂõæÊ∑ªÂä†Êï∞ÊçÆÊ†áÁ≠æ
                if (chartInfo.type === 'scatter') {
                    miniConfig.options.plugins.datalabels = {
                        display: false // Êï£ÁÇπÂõæÊï∞ÊçÆÁÇπËæÉÂ§öÔºå‰∏çÊòæÁ§∫Ê†áÁ≠æÈÅøÂÖçÈáçÂè†
                    };
                }

                new Chart(ctx, miniConfig);
            });
        }

        // Show smart suggestions
        function showSuggestions() {
            if (!currentData) return;

            const suggestions = [];
            
            // Analyze data characteristics
            if (currentData.headers.length > 2) {
                suggestions.push('Multiple columns detected, consider using dual-axis mode to compare different metrics');
            }
            
            if (currentData.data.length > 20) {
                suggestions.push('Large dataset detected, consider using line chart to show trends');
            }
            
            if (currentData.headers.some(h => h.includes('Rate') || h.includes('%') || h.includes('Áéá') || h.includes('%'))) {
                suggestions.push('Percentage data detected, consider using pie chart or bar chart');
            }

            if (suggestions.length > 0) {
                const html = `
                    <div class="suggestion-box">
                        <div class="suggestion-title">üí° Smart Suggestions</div>
                        ${suggestions.map(s => `<div>‚Ä¢ ${s}</div>`).join('')}
                    </div>
                `;
                document.getElementById('suggestions').innerHTML = html;
            }
        }

        // Âä†ËΩΩÁ§∫‰æãÊï∞ÊçÆ
        function loadSampleData(type) {
            const sample = sampleDatasets[type];
            if (sample) {
                currentData = {
                    headers: [...sample.headers],
                    data: sample.data.map(row => [...row])
                };
                displayDataPreview();
                generateChart();
                showSuggestions();
                saveToStorage();
            }
        }

        // ÂàáÊç¢ÂõæË°®Á±ªÂûã
        function changeChartType(type) {
            currentChartType = type;
            
            // Â¶ÇÊûúÂΩìÂâçÂ§Ñ‰∫éËø∑‰Ω†ÂõæÊ®°ÂºèÔºåËá™Âä®ÈÄÄÂá∫Ëø∑‰Ω†ÂõæÊ®°Âºè
            if (isMiniMode) {
                isMiniMode = false;
                const mainContainer = document.getElementById('chartContainer');
                const miniContainer = document.getElementById('miniChartsContainer');
                mainContainer.style.display = 'block';
                miniContainer.style.display = 'none';
                
                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                updateButtonStates();
            }
            
            generateChart();
        }

        // ÂàáÊç¢ÂèåËΩ¥Ê®°Âºè
        function toggleDualAxis() {
            // Â¶ÇÊûúÂΩìÂâçÊòØËø∑‰Ω†ÂõæÊ®°ÂºèÔºåÂÖàÈÄÄÂá∫Ëø∑‰Ω†ÂõæÊ®°Âºè
            if (isMiniMode) {
                isMiniMode = false;
                const mainContainer = document.getElementById('chartContainer');
                const miniContainer = document.getElementById('miniChartsContainer');
                mainContainer.style.display = 'block';
                miniContainer.style.display = 'none';
            }
            
            isDualAxis = !isDualAxis;
            updateButtonStates();
            generateChart();
        }

        // ÂàáÊç¢Ëø∑‰Ω†ÂõæÊ®°Âºè
        function toggleMiniCharts() {
            // Â¶ÇÊûúÂΩìÂâçÊòØÂèåËΩ¥Ê®°ÂºèÔºåÂÖàÈÄÄÂá∫ÂèåËΩ¥Ê®°Âºè
            if (isDualAxis) {
                isDualAxis = false;
            }
            
            isMiniMode = !isMiniMode;
            
            const mainContainer = document.getElementById('chartContainer');
            const miniContainer = document.getElementById('miniChartsContainer');
            
            if (isMiniMode) {
                mainContainer.style.display = 'none';
                miniContainer.style.display = 'grid';
            } else {
                mainContainer.style.display = 'block';
                miniContainer.style.display = 'none';
            }
            
            updateButtonStates();
            generateChart();
        }
        
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        function updateButtonStates() {
            // Êõ¥Êñ∞ÂèåËΩ¥ÊåâÈíÆÁä∂ÊÄÅ
            const dualAxisBtn = document.querySelector('button[onclick="toggleDualAxis()"]');
            if (dualAxisBtn) {
                if (isDualAxis) {
                    dualAxisBtn.style.backgroundColor = '#007bff';
                    dualAxisBtn.style.color = 'white';
                } else {
                    dualAxisBtn.style.backgroundColor = '';
                    dualAxisBtn.style.color = '';
                }
            }
            
            // Êõ¥Êñ∞Ëø∑‰Ω†ÂõæÊåâÈíÆÁä∂ÊÄÅ
            const miniChartsBtn = document.querySelector('button[onclick="toggleMiniCharts()"]');
            if (miniChartsBtn) {
                if (isMiniMode) {
                    miniChartsBtn.style.backgroundColor = '#007bff';
                    miniChartsBtn.style.color = 'white';
                } else {
                    miniChartsBtn.style.backgroundColor = '';
                    miniChartsBtn.style.color = '';
                }
            }
        }

        // ÂàáÊç¢‰∏ªÈ¢ò
        function changeTheme(themeId) {
            currentTheme = themeId;
            
            // Êõ¥Êñ∞‰∏ªÈ¢òÈÄâÊã©Âô®
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
            document.querySelector(`.theme-${themeId}`).classList.add('active');
            
            generateChart();
        }

        // Êõ¥Êñ∞ÂõæË°®
        function updateChart() {
            generateChart();
        }

        // Export chart
        function exportChart(format) {
            if (!currentChart && !isMiniMode) {
                alert('Please generate a chart first');
                return;
            }

            if (format === 'png') {
                const canvas = document.getElementById('mainChart');
                const link = document.createElement('a');
                link.download = 'chart.png';
                link.href = canvas.toDataURL();
                link.click();
            } else if (format === 'svg') {
                // ÂàõÂª∫SVGÂØºÂá∫
                const canvas = document.getElementById('mainChart');
                const ctx = canvas.getContext('2d');
                
                // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂canvasÊù•Ëé∑ÂèñÂõæË°®Êï∞ÊçÆ
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Â§çÂà∂ÂΩìÂâçÂõæË°®Âà∞‰∏¥Êó∂canvas
                tempCtx.drawImage(canvas, 0, 0);
                
                // Â∞ÜcanvasËΩ¨Êç¢‰∏∫SVG
                const svgData = canvasToSVG(tempCanvas);
                
                // ‰∏ãËΩΩSVGÊñá‰ª∂
                const blob = new Blob([svgData], { type: 'image/svg+xml' });
                const link = document.createElement('a');
                link.download = 'chart.svg';
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
            }
        }
        
        // CanvasËΩ¨SVGÁöÑËæÖÂä©ÂáΩÊï∞
        function canvasToSVG(canvas) {
            const dataURL = canvas.toDataURL('image/png');
            const svgTemplate = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${canvas.width}" height="${canvas.height}" viewBox="0 0 ${canvas.width} ${canvas.height}">
  <image width="${canvas.width}" height="${canvas.height}" xlink:href="${dataURL}"/>
</svg>`;
            return svgTemplate;
        }

        // Export HTML
        function exportHTML() {
            if (!currentChart) {
                alert('Please generate a chart first');
                return;
            }

            const canvas = document.getElementById('mainChart');
            const dataURL = canvas.toDataURL();
            
            const html = `
                <div style="text-align: center; padding: 20px;">
                    <img src="${dataURL}" alt="Chart" style="max-width: 100%; height: auto;">
                </div>
            `;
            
            const blob = new Blob([html], { type: 'text/html' });
            const link = document.createElement('a');
            link.download = 'chart.html';
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        // Generate share link
        function generateShareLink() {
            if (!currentData) {
                alert('Please load data first');
                return;
            }

            const shareData = {
                data: currentData,
                chartType: currentChartType,
                theme: currentTheme,
                settings: {
                    showLegend: document.getElementById('showLegend').checked,
                    showGrid: document.getElementById('showGrid').checked,
                    title: document.getElementById('chartTitle').value
                }
            };

            try {
                const compressed = btoa(encodeURIComponent(JSON.stringify(shareData)));
                
                // ÊûÑÂª∫ÂàÜ‰∫´URLÔºåÂÖºÂÆπÊú¨Âú∞Êñá‰ª∂ÂíåHTTPÊúçÂä°Âô®
                let baseURL;
                if (window.location.protocol === 'file:') {
                    baseURL = window.location.href.split('#')[0];
                } else {
                    baseURL = `${window.location.origin}${window.location.pathname}`;
                }
                
                const shareURL = `${baseURL}#${compressed}`;
                
                if (shareURL.length > 8000) {
                    alert('Data too large to generate share link');
                    return;
                }

                // Try to copy to clipboard
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(shareURL).then(() => {
                        alert('Share link copied to clipboard!\n\nNote: If using local file, ensure recipient has the same HTML file.');
                    }).catch(() => {
                        showShareDialog(shareURL);
                    });
                } else {
                    showShareDialog(shareURL);
                }
            } catch (error) {
                alert('Failed to generate share link: data too large or contains special characters');
                console.error('Share link generation error:', error);
            }
        }
        
        // Show share dialog
        function showShareDialog(shareURL) {
            const result = prompt('Share link generated, please copy:\n\nNote: If using local file, ensure recipient has the same HTML file.', shareURL);
            if (result !== null) {
                alert('Please manually copy the link above to share');
            }
        }

        // Load data from URL
        function loadFromURL() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                try {
                    // Try new decoding method (with URI encoding)
                    let shareData;
                    try {
                        shareData = JSON.parse(decodeURIComponent(atob(hash)));
                    } catch (e) {
                        // Compatible with old decoding method
                        shareData = JSON.parse(atob(hash));
                    }
                    
                    currentData = shareData.data;
                    currentChartType = shareData.chartType || 'bar';
                    currentTheme = shareData.theme || 1;
                    
                    if (shareData.settings) {
                        document.getElementById('showLegend').checked = shareData.settings.showLegend !== false;
                        document.getElementById('showGrid').checked = shareData.settings.showGrid !== false;
                        document.getElementById('chartTitle').value = shareData.settings.title || '';
                    }
                    
                    displayDataPreview();
                    generateChart();
                    changeTheme(currentTheme);
                    
                    // Show success loading message
                    setTimeout(() => {
                        alert('Successfully loaded data from share link!');
                    }, 500);
                } catch (error) {
                    console.error('Unable to parse share link:', error);
                    alert('Share link format error or data corrupted');
                }
            }
        }

        // Save to local storage
        function saveToStorage() {
            if (currentData) {
                const saveData = {
                    data: currentData,
                    chartType: currentChartType,
                    theme: currentTheme,
                    timestamp: Date.now()
                };
                localStorage.setItem('chartTool_lastSession', JSON.stringify(saveData));
            }
        }

        // Load from local storage
        function loadFromStorage() {
            const saved = localStorage.getItem('chartTool_lastSession');
            if (saved && !window.location.hash) {
                try {
                    const saveData = JSON.parse(saved);
                    // Only load data within 24 hours
                    if (Date.now() - saveData.timestamp < 24 * 60 * 60 * 1000) {
                        currentData = saveData.data;
                        currentChartType = saveData.chartType || 'bar';
                        currentTheme = saveData.theme || 1;
                        
                        displayDataPreview();
                        generateChart();
                        changeTheme(currentTheme);
                    }
                } catch (error) {
                    console.error('Unable to load local data:', error);
                }
            }
        }

        // Show/hide loading animation
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>